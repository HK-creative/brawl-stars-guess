# 10 – API Contracts

This project uses **Supabase** as its only backend. There is no custom REST API
server—every request goes directly to Supabase PostgREST endpoints or Edge
Functions automatically generated by Supabase.

The purpose of this document is to capture the *shape* of the data (tables &
rows), plus any custom function endpoints so that front-end and serverless code
stay in lock-step.  **Update this file whenever columns or payloads change.**

---

## 1. Database schema (public)

Tables are defined in `src/integrations/supabase/types.ts` (generated by
`supabase gen types typescript --linked`).  Below is a human-readable summary.

### 1.1 `daily_challenges`

| Column          | Type      | Nullable | Notes |
| --------------- | --------- | -------- | ----- |
| `id`            | `uuid`    | ✘        | Primary key (auto-generated) |
| `mode`          | `text`    | ✘        | One of `classic`, `gadget`, `starpower`, `audio`, `pixels` |
| `challenge_data`| `jsonb`   | ✘        | Mode-specific payload (see below) |
| `date`          | `date`    | ✘        | UTC+2 calendar date (`YYYY-MM-DD`) |
| `created_at`    | `timestamp`| ✔︎       | Server default `now()` |

`challenge_data` differs by game mode:

* **classic** – string (brawler name).
* **gadget / starpower** – `{ "brawler": string, "gadget": string }` or `{ "brawler": string, "starpower": string }`.
* **audio** – `{ "brawler": string, "audio": string, "hintAudio"?: string }`.
* **pixels** – `{ "brawler": string, "image": string }`.

> Front-end helpers (`lib/daily-challenges.ts`) coerce these shapes; validate on
> change.

### 1.2 `profiles`

| Column                | Type      | Nullable | Notes |
| --------------------- | --------- | -------- | ----- |
| `id`                  | `uuid`    | ✘        | Matches Supabase `auth.users.id` |
| `current_streak`      | `int4`    | ✘        | Count of consecutive daily completions |
| `last_completed_date` | `date`    | ✔︎       | UTC+2 date when a daily mode was last completed |

Updates are performed client-side via `StreakContext.tsx`.

---

## 2. Authentication

Handled by `@supabase/supabase-js` PKCE flow:

```ts
supabase.auth.signInWithOAuth({ provider: 'google' })
```

The callback route `/auth/callback` exchanges `code` for a session.  Session is
persisted in `localStorage` under key `brawldle-auth-token` (see
`supabase/client.ts`).

**Public reads** of `daily_challenges` table do **not** require auth.
Writes (e.g., to `profiles`) require the user to be signed in; RLS policies on
Supabase restrict updates to `auth.uid()`.

---

## 3. Edge Functions

Supabase automatically exposes functions at
`https://<project>.supabase.co/functions/v1/<name>`.

| Function name                 | Method | Auth header required | Body / Params | Response |
| ----------------------------- | ------ | ------------------- | ------------- | -------- |
| `generate-daily-challenges`   | `POST` | `Service-Role` (cron only) | none | `{ message: string, classic: string }` |
| `cron-setup`                  | `POST` | `Service-Role` (one-off) | none | `{ message: string, result: any }` |

The front-end **never** calls these functions directly.  They are invoked by
Supabase's internal scheduler (`pg_cron`) set up via `cron-setup`.

---

## 4. PostgREST endpoints

Supabase ships a ready-made REST interface. Example call (not used in code but
handy for debugging):

```bash
curl "https://zkqlqveltfxvelxzyyik.supabase.co/rest/v1/daily_challenges?date=eq.2024-08-01" \
  -H "apikey: $SUPABASE_ANON_KEY" \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY"
```

Queries accept standard PostgREST filters (`eq`, `lt`, etc.).

---

## 5. Client usage patterns

### 5.1 Fetch today's classic challenge

```ts
const { data, error } = await supabase
  .from('daily_challenges')
  .select('challenge_data')
  .eq('mode', 'classic')
  .eq('date', getCurrentDateUTC2())
  .single()
```

### 5.2 Update user streak

```ts
await supabase.from('profiles').upsert({
  id: user.id,
  current_streak: streak + 1,
  last_completed_date: today,
})
```

These snippets must match the schema above; adjust both when the table changes.

---

## 6. Error handling contract

* Database/API errors should be logged via `console.error` and surfaced to the
  UI using the `toast` helper.
* Edge Functions return JSON with either `error` or `message` key.  Functions
  never return HTML.

Standardise on this pattern for any future functions.

---

Keep this contract in sync with Supabase migrations and front-end helpers.
Breaking changes without an update here will trip up future contributors and AI
agents. 